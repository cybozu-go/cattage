<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cattage Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Cattage</a></li><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">2.</strong> Setup</a></li><li class="chapter-item expanded "><a href="usage.html"><strong aria-hidden="true">3.</strong> Usage</a></li><li class="chapter-item expanded "><a href="sharding.html"><strong aria-hidden="true">4.</strong> Sharding</a></li><li class="chapter-item expanded "><a href="crd_tenant.html"><strong aria-hidden="true">5.</strong> Tenant custom resource</a></li><li class="chapter-item expanded "><a href="config.html"><strong aria-hidden="true">6.</strong> Configurations</a></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">7.</strong> Design notes</a></li><li class="chapter-item expanded "><a href="development.html"><strong aria-hidden="true">8.</strong> Development</a></li><li class="chapter-item expanded "><a href="release.html"><strong aria-hidden="true">9.</strong> Release procedure</a></li><li class="chapter-item expanded "><a href="maintenance.html"><strong aria-hidden="true">10.</strong> Maintenance</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cattage Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/cybozu-go/cattage" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="cattage-documentation"><a class="header" href="#cattage-documentation">Cattage documentation</a></h1>
<p>Cattage is a Kubernetes controller that enhances the multi-tenancy of <a href="https://argo-cd.readthedocs.io/en/stable/">Argo CD</a> with <a href="https://github.com/cybozu-go/accurate">Accurate</a>.
It is currently developed and maintained by <a href="https://cybozu-global.com/">Cybozu</a>.</p>
<p>The repository is at <a href="https://github.com/cybozu-go/cattage">https://github.com/cybozu-go/cattage</a> .</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>Cattage is a Kubernetes controller that enhances the multi-tenancy of <a href="https://argo-cd.readthedocs.io/en/stable/">Argo CD</a> with <a href="https://github.com/cybozu-go/accurate">Accurate</a>.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li>
<p>Management of root-namespaces for tenants</p>
<p>When an administrator creates a <a href="crd_tenant.html">tenant resource</a>, root-namespaces for the tenant will be created.
A RoleBinding resource will be created in the namespace so that the namespace can only be accessed by the tenant's users.
Tenant users can create sub-namespaces in those root-namespaces.</p>
</li>
<li>
<p>Automatic update of Argo CD AppProject resources</p>
<p>An AppProject resource can control namespaces where users can deploy manifests.
When a tenant user creates a sub-namespace, the AppProject will be automatically updated accordingly.
Tenant users will be able to deploy applications with Argo CD to the namespaces.</p>
</li>
<li>
<p>The ownership of sub-namespaces can be changed between tenants</p>
<p>Sometimes users may want to move the ownership of an application to another tenant.
When the parent of a sub-namespace is changed, Cattage will automatically update the permissions.</p>
</li>
<li>
<p>Sharding application-controller instances</p>
<p>Cattage can shard application-controller instances by the tenant.
This feature is useful when you have a large number of tenants and want to avoid a single application-controller instance from being overloaded.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<h2 id="kubernetes-cluster"><a class="header" href="#kubernetes-cluster">Kubernetes cluster</a></h2>
<p>Cattage is a controller that runs in a soft multi-tenancy Kubernetes cluster.
Namespaces must be isolated for each tenant.</p>
<p>There are many ways to achieve Namespace isolation.
In EKS and GKE, you can integrate RBAC with IAM.
For on-premises, <a href="https://goteleport.com">Teleport</a> and <a href="https://loft.sh">Loft</a> may help you.</p>
<h2 id="argo-cd"><a class="header" href="#argo-cd">Argo CD</a></h2>
<p>Install Argo CD as shown in the following page:</p>
<p><a href="https://argo-cd.readthedocs.io/en/stable/getting_started/">https://argo-cd.readthedocs.io/en/stable/getting_started/</a></p>
<p>Cattage isolates AppProject resource for each tenant.</p>
<p>So, please refer to the following page to enable user management.
Argo CD supports a lot of authentication methods.</p>
<p><a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/">https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/</a></p>
<p>Cattage expects tenant users to be able to create Application resources.
Apply the following manifest:</p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: application-admin
  labels:
    rbac.authorization.k8s.io/aggregate-to-admin: "true"
rules:
- apiGroups:
  - argoproj.io
  resources:
  - applications
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
  - deletecollection
</code></pre>
<p>Cattage requires Argo CD's <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/">Applications in any namespace</a> is enabled.
In order to enable the feature, add <code>--application-namespace="*"</code> parameter to <code>argocd-server</code> and <code>argocd-application-controller</code>.</p>
<h2 id="cert-manager"><a class="header" href="#cert-manager">cert-manager</a></h2>
<p>Cattage and Accurate depend on <a href="https://cert-manager.io/">cert-manager</a> to issue TLS certificate for admission webhooks.
If cert-manager is not installed on your cluster, install it as follows:</p>
<pre><code class="language-sh">curl -fsLO https://github.com/jetstack/cert-manager/releases/latest/download/cert-manager.yaml
kubectl apply -f cert-manager.yaml
</code></pre>
<h2 id="accurate"><a class="header" href="#accurate">Accurate</a></h2>
<p>Cattage depends on Accurate.
It expects <code>cattage.cybozu.io/tenant</code> labels and RoleBinding resources to be propagated.</p>
<p>Include the following settings in your values.yaml:</p>
<pre><code class="language-yaml">controller:
  config:
    labelKeys:
      - cattage.cybozu.io/tenant
    watches:
      - group: rbac.authorization.k8s.io
        version: v1
        kind: RoleBinding
</code></pre>
<p>Install Accurate with the values.yaml as follows:</p>
<pre><code class="language-sh">helm install --create-namespace --namespace accurate accurate -f values.yaml accurate/accurate
</code></pre>
<p>For more information, see the following page:</p>
<p><a href="https://cybozu-go.github.io/accurate/helm.html">https://cybozu-go.github.io/accurate/helm.html</a></p>
<h2 id="cattage"><a class="header" href="#cattage">Cattage</a></h2>
<p>Prepare values.yaml as follows:</p>
<pre><code class="language-yaml">controller:
  config:
    namespace:
      roleBindingTemplate: |
        apiVersion: rbac.authorization.k8s.io/v1
        kind: RoleBinding
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: admin
        subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: Group
            name: {{ .Name }}
          {{- range .Roles.admin }}
          - apiGroup: rbac.authorization.k8s.io
            kind: Group
            name: {{ .Name }}
          {{- end }}
    argocd:
      namespace: argocd
      appProjectTemplate: |
        apiVersion: argoproj.io/v1alpha1
        kind: AppProject
        spec:
          destinations:
          {{- range .Namespaces }}
            - namespace: {{ . }}
              server: '*'
          {{- end }}
          roles:
            - groups:
                - {{ .Name }}
                {{- range .Roles.admin }}
                - {{ .Name }}
                {{- end }}
              name: admin
              policies:
                - p, proj:{{ .Name }}:admin, applications, *, {{ .Name }}/*, allow
          sourceNamespaces:
            {{- range .Namespaces }}
            - {{ . }}
            {{- end }}
          sourceRepos:
            {{- range .Repositories }}
            - '{{ . }}'
            {{- else }}
            - '*'
            {{- end }}
</code></pre>
<p><code>appProjectTemplate</code> and <code>roleBindingTemplate</code> should be configured appropriately for your multi-tenancy environment.
Read <a href="config.html">Configurations</a> for details.</p>
<p>Setup Helm repository:</p>
<pre><code class="language-sh">helm repo add cattage https://cybozu-go.github.io/cattage
helm repo update
</code></pre>
<p>Install the Helm chart with your values.yaml:</p>
<pre><code class="language-sh">helm install --create-namespace --namespace cattage cattage cattage/cattage -f values.yaml
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="usage"><a class="header" href="#usage">Usage</a></h1>
<h2 id="create-a-tenant-resource"><a class="header" href="#create-a-tenant-resource">Create a Tenant resource</a></h2>
<p>Administrators can create the following tenant resource for a tenant team.</p>
<pre><code class="language-yaml">apiVersion: cattage.cybozu.io/v1beta1
kind: Tenant
metadata:
  name: your-team
spec:
  rootNamespaces:
    - name: your-root
</code></pre>
<p>The name of the tenant resource must match the name of the group in Kubernetes and Argo CD.
The namespaces specified in <code>spec.rootNamespaces</code> will be created automatically.</p>
<pre><code class="language-console">$ kubectl get ns your-root
NAME        STATUS   AGE
your-root   Active   1m
</code></pre>
<p>RoleBinding and AppProject resource are also automatically created.</p>
<pre><code class="language-console">$ kubeclt get rolebinding -n your-root
NAME              ROLE                AGE
your-team-admin   ClusterRole/admin   2m
</code></pre>
<pre><code class="language-console">$ kubectl get appproject -n argocd your-team
NAME        AGE
your-team   2m
</code></pre>
<h2 id="create-an-application-resource"><a class="header" href="#create-an-application-resource">Create an Application resource</a></h2>
<p>Tenant users can create a SubNamespace on their namespaces.</p>
<pre><code class="language-sh">kubectl accurate sub create your-sub your-root
</code></pre>
<p>Tenant users can create an Application resource in the sub-namespace.</p>
<p>Prepare an Application resource as follows:</p>
<pre><code class="language-yaml">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: testhttpd
  namespace: your-sub
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: your-team
  source:
    repoURL: https://github.com/cybozu-go/cattage.git
    targetRevision: main
    path: samples/testhttpd
  destination:
    server: https://kubernetes.default.svc
    namespace: your-sub
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
</code></pre>
<p>Apply the resource:</p>
<pre><code class="language-sh">kubectl apply -f application.yaml
</code></pre>
<p>Make sure that the Application resource is synchronized.</p>
<pre><code class="language-console">$ kubectl get application -n your-sub
NAME        SYNC STATUS   HEALTH STATUS
testhttpd   Synced        Healthy
</code></pre>
<h2 id="how-to-manage-resources-that-already-exist"><a class="header" href="#how-to-manage-resources-that-already-exist">How to manage resources that already exist</a></h2>
<p>Cattage can manage resources that have existed before with Tenant and Application.</p>
<p>You can make an existing namespace belong to Tenant.
However, the namespace must be root or not managed by accurate.</p>
<p>A RoleBinding resource named <code>&lt;tenant-name&gt;-admin</code> will be created on a namespace belonging to a tenant.
If a resource with the same name already exists, it will be overwritten.</p>
<p>An AppProject resource with the same name as a tenant will be created in argocd namespace.
If a resource with the same name already exists, it will be overwritten.</p>
<h2 id="how-to-change-ownership"><a class="header" href="#how-to-change-ownership">How to change ownership</a></h2>
<p>The ownership of sub-namespace can be transferred to other tenant.</p>
<p>Prepare a new tenant:</p>
<pre><code class="language-yaml">apiVersion: cattage.cybozu.io/v1beta1
kind: Tenant
metadata:
  name: new-team
spec:
  rootNamespaces:
    - name: new-root
</code></pre>
<p>Use <code>kubectl accurate sub move</code> command to change the parent of your-sub namespace to new-root.</p>
<pre><code class="language-console">$ kubectl accurate sub move your-sub new-root
</code></pre>
<p>As a result, <code>application/testhttpd</code> in your-sub will be out of sync.
Please change the project of <code>application/testhttpd</code> correctly.</p>
<pre><code class="language-console">$ kubectl patch app testhttpd -n your-sub --type='json' -p '[{ "op": "replace", "path": "/spec/project", "value": "new-team"}]'
</code></pre>
<p>The application will be synced again.</p>
<h2 id="remove-resources"><a class="header" href="#remove-resources">Remove resources</a></h2>
<p>When an administrator deleted a tenant resource:</p>
<ul>
<li>Root-namespaces and sub-namespaces for the tenant will remain</li>
<li>RoleBinding on the namespaces will be deleted</li>
<li>Applications on the namespaces will be deleted</li>
<li>AppProject for the tenant will be deleted</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sharding"><a class="header" href="#sharding">Sharding</a></h1>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>In Argo CD, as the number of managed applications increases, the load on the Application Controller becomes significant.
While Argo CD supports sharding, it can only shard controllers per Kubernetes cluster. (ref. <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/high_availability/">https://argo-cd.readthedocs.io/en/stable/operator-manual/high_availability/</a> )</p>
<p>Cattage provides the capability to shard controllers on a per-tenant basis using <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/">applications in any namespace</a>.
By specifying a controller name in the Tenant resource, you can designate which controller will process Applications created in that tenant's Namespaces.</p>
<h2 id="how-to-use"><a class="header" href="#how-to-use">How to use</a></h2>
<h3 id="setup-stakaterreloader"><a class="header" href="#setup-stakaterreloader">Setup stakater/Reloader</a></h3>
<p><a href="https://github.com/stakater/Reloader">stakater/Reloader</a> is a Kubernetes controller that watches for changes in ConfigMaps and Secrets, executing rolling updates on Deployments and StatefulSets as needed.
Cattage uses <code>stakater/Reloader</code> to roll out updates to the Argo CD Application Controller whenever a ConfigMap is modified.</p>
<p>Follow these steps to set it up:</p>
<pre><code class="language-bash">helm repo add stakater https://stakater.github.io/stakater-charts
helm repo update
helm install --create-namespace --namespace reloader reloader -f manifests/reloader-values.yaml stakater/reloader
</code></pre>
<h3 id="setup-argocd"><a class="header" href="#setup-argocd">Setup ArgoCD</a></h3>
<p>Set up Argo CD with the following commands:</p>
<pre><code class="language-bash">helm repo add argo https://argoproj.github.io/argo-helm
helm repo update
helm install --create-namespace --namespace argocd argocd argo/argo-cd
</code></pre>
<p>Copy and rename the StatefulSet for the Application Controller, then deploy it.
Repeat for as many controllers as required for sharding:</p>
<pre><code class="language-bash">helm template argo/argo-cd | yq ea '. as $$i ireduce ([]; . + $$i) | .[] | select(.kind=="StatefulSet") | .metadata.name="second-application-controller"' | kubectl apply -f -
</code></pre>
<p>Apply patches to the Application Controllers, ArgoCD Server, and Notification Controller to use the ConfigMaps generated by Cattage, and add an annotation to enable <code>stakater/Reloader</code>.</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: argocd-application-controller
  namespace: argocd
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  template:
    spec:
      containers:
        - env:
            - name: ARGOCD_APPLICATION_NAMESPACES
              valueFrom:
                configMapKeyRef:
                  key: application.namespaces
                  name: default-application-controller-cm
                  optional: true
          name: application-controller
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: second-application-controller
  namespace: argocd
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  template:
    spec:
      containers:
        - env:
            - name: ARGOCD_APPLICATION_NAMESPACES
              valueFrom:
                configMapKeyRef:
                  key: application.namespaces
                  name: second-application-controller-cm
                  optional: true
          name: application-controller
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-notifications-controller
  namespace: argocd
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  template:
    spec:
      containers:
        - env:
            - name: ARGOCD_APPLICATION_NAMESPACES
              valueFrom:
                configMapKeyRef:
                  key: application.namespaces
                  name: all-tenant-namespaces-cm
                  optional: true
          name: notifications-controller
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-server
  namespace: argocd
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  template:
    spec:
      containers:
        - env:
            - name: ARGOCD_APPLICATION_NAMESPACES
              valueFrom:
                configMapKeyRef:
                  key: application.namespaces
                  name: all-tenant-namespaces-cm
                  optional: true
          name: server
</code></pre>
<p>Cattage generates the following configmaps:</p>
<ul>
<li><code>all-tenant-namespaces-cm</code>: Lists namespaces belonging to all tenants</li>
<li><code>default-application-controller-cm</code>: Lists namespaces for tenants without a specified controller</li>
<li><code>&lt;controller name&gt;-application-controller-cm</code>: Lists namespaces for tenants with a specified controller</li>
</ul>
<h3 id="setup-cattage"><a class="header" href="#setup-cattage">Setup Cattage</a></h3>
<p>Follow the <a href="./setup.html">setup instructions</a> to install Cattage.</p>
<p>Ensure <code>controller.config.argocd.preventAppCreationInArgoCDNamespace</code> in values.yaml is enabled to avoid multiple controllers processing the same Application in argocd namespace.</p>
<h3 id="creating-tenant-resources"><a class="header" href="#creating-tenant-resources">Creating Tenant Resources</a></h3>
<p>When creating a Tenant resource, specify the controllerName.</p>
<pre><code class="language-yaml">apiVersion: cattage.cybozu.io/v1beta1
kind: Tenant
metadata:
  name: a-team
spec:
  rootNamespaces:
    - name: app-a
  controllerName: second
</code></pre>
<p>Applications created in the Namespace of that tenant will then be processed by the specified application controller.
If no controller name is specified, it will be processed by the default application controller.</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="custom-resources"><a class="header" href="#custom-resources">Custom Resources</a></h3>
<ul>
<li><a href="crd_tenant.html#tenant">Tenant</a></li>
</ul>
<h3 id="sub-resources"><a class="header" href="#sub-resources">Sub Resources</a></h3>
<ul>
<li><a href="crd_tenant.html#argocdspec">ArgoCDSpec</a></li>
<li><a href="crd_tenant.html#delegatespec">DelegateSpec</a></li>
<li><a href="crd_tenant.html#rootnamespacespec">RootNamespaceSpec</a></li>
<li><a href="crd_tenant.html#tenantlist">TenantList</a></li>
<li><a href="crd_tenant.html#tenantspec">TenantSpec</a></li>
<li><a href="crd_tenant.html#tenantstatus">TenantStatus</a></li>
</ul>
<h4 id="argocdspec"><a class="header" href="#argocdspec">ArgoCDSpec</a></h4>
<p>ArgoCDSpec defines the desired state of the settings for Argo CD.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr></thead><tbody>
<tr><td>repositories</td><td>Repositories contains list of repository URLs which can be used by the tenant.</td><td>[]string</td><td>false</td></tr>
</tbody></table>
</div>
<p><a href="crd_tenant.html#custom-resources">Back to Custom Resources</a></p>
<h4 id="delegatespec"><a class="header" href="#delegatespec">DelegateSpec</a></h4>
<p>DelegateSpec defines a tenant that is delegated access to a tenant.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr></thead><tbody>
<tr><td>name</td><td>Name is the name of a delegated tenant.</td><td>string</td><td>true</td></tr>
<tr><td>roles</td><td>Roles is a list of roles that the tenant has.</td><td>[]string</td><td>true</td></tr>
</tbody></table>
</div>
<p><a href="crd_tenant.html#custom-resources">Back to Custom Resources</a></p>
<h4 id="rootnamespacespec"><a class="header" href="#rootnamespacespec">RootNamespaceSpec</a></h4>
<p>RootNamespaceSpec defines the desired state of Namespace.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr></thead><tbody>
<tr><td>name</td><td>Name is the name of namespace to be generated.</td><td>string</td><td>true</td></tr>
<tr><td>labels</td><td>Labels are the labels to add to the namespace. This supersedes <code>namespace.commonLabels</code> in the configuration.</td><td>map[string]string</td><td>false</td></tr>
<tr><td>annotations</td><td>Annotations are the annotations to add to the namespace. This supersedes <code>namespace.commonAnnotations</code> in the configuration.</td><td>map[string]string</td><td>false</td></tr>
</tbody></table>
</div>
<p><a href="crd_tenant.html#custom-resources">Back to Custom Resources</a></p>
<h4 id="tenant"><a class="header" href="#tenant">Tenant</a></h4>
<p>Tenant is the Schema for the tenants API.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr></thead><tbody>
<tr><td>metadata</td><td></td><td>metav1.ObjectMeta</td><td>false</td></tr>
<tr><td>spec</td><td></td><td><a href="crd_tenant.html#tenantspec">TenantSpec</a></td><td>false</td></tr>
<tr><td>status</td><td></td><td><a href="crd_tenant.html#tenantstatus">TenantStatus</a></td><td>false</td></tr>
</tbody></table>
</div>
<p><a href="crd_tenant.html#custom-resources">Back to Custom Resources</a></p>
<h4 id="tenantlist"><a class="header" href="#tenantlist">TenantList</a></h4>
<p>TenantList contains a list of Tenant.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr></thead><tbody>
<tr><td>metadata</td><td></td><td>metav1.ListMeta</td><td>false</td></tr>
<tr><td>items</td><td></td><td>[]<a href="crd_tenant.html#tenant">Tenant</a></td><td>true</td></tr>
</tbody></table>
</div>
<p><a href="crd_tenant.html#custom-resources">Back to Custom Resources</a></p>
<h4 id="tenantspec"><a class="header" href="#tenantspec">TenantSpec</a></h4>
<p>TenantSpec defines the desired state of Tenant.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr></thead><tbody>
<tr><td>rootNamespaces</td><td>RootNamespaces are the list of root namespaces that belong to this tenant.</td><td>[]<a href="crd_tenant.html#rootnamespacespec">RootNamespaceSpec</a></td><td>true</td></tr>
<tr><td>argocd</td><td>ArgoCD is the settings of Argo CD for this tenant.</td><td><a href="crd_tenant.html#argocdspec">ArgoCDSpec</a></td><td>false</td></tr>
<tr><td>delegates</td><td>Delegates is a list of other tenants that are delegated access to this tenant.</td><td>[]<a href="crd_tenant.html#delegatespec">DelegateSpec</a></td><td>false</td></tr>
<tr><td>controllerName</td><td>ControllerName is the name of the application-controller that manages this tenant's applications. If not specified, the default controller is used.</td><td>string</td><td>false</td></tr>
<tr><td>extraParams</td><td>ExtraParams is a map of extra parameters that can be used in the templates.</td><td>*Params</td><td>false</td></tr>
</tbody></table>
</div>
<p><a href="crd_tenant.html#custom-resources">Back to Custom Resources</a></p>
<h4 id="tenantstatus"><a class="header" href="#tenantstatus">TenantStatus</a></h4>
<p>TenantStatus defines the observed state of Tenant.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr></thead><tbody>
<tr><td>health</td><td>Health is the health of Tenant.</td><td>TenantHealth</td><td>false</td></tr>
<tr><td>conditions</td><td>Conditions is an array of conditions.</td><td>[]metav1.Condition</td><td>false</td></tr>
</tbody></table>
</div>
<p><a href="crd_tenant.html#custom-resources">Back to Custom Resources</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configurations"><a class="header" href="#configurations">Configurations</a></h1>
<h2 id="configuration-file"><a class="header" href="#configuration-file">Configuration file</a></h2>
<p><code>cattage-controller</code> reads a configuration file on startup. The default location is <code>/etc/cattage/config.yaml</code>.
The location can be changed with <code>--config-file</code> flag.</p>
<p>The configuration file should be a JSON or YAML file having the following keys:</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>namespace.commonLabels</code></td><td><code>map[string]string</code></td><td>Labels to be added to all namespaces belonging to all tenants. This may be overridden by <code>rootNamespaces.labels</code> of a tenant resource.</td></tr>
<tr><td><code>namespace.commonAnnotations</code></td><td><code>map[string]string</code></td><td>Annotations to be added to all namespaces belonging to all tenants. This may be overridden by <code>rootNamespaces.annotations</code> of a tenant resource.</td></tr>
<tr><td><code>namespace.roleBindingTemplate</code></td><td><code>string</code></td><td>Template for RoleBinding resource that is created on all namespaces belonging to a tenant.</td></tr>
<tr><td><code>argocd.namepsace</code></td><td><code>string</code></td><td>The name of namespace where Argo CD is running.</td></tr>
<tr><td><code>argocd.appProjectTemplate</code></td><td><code>string</code></td><td>Template for AppProject resources that is created for each tenant.</td></tr>
<tr><td><code>argocd.preventAppCreationInArgoCDNamespace</code></td><td><code>bool</code></td><td>If true, prevent creating applications in the Argo CD namespace. This is used to enable sharding.</td></tr>
</tbody></table>
</div>
<p>The repository includes an example as follows:</p>
<pre><code class="language-yaml">namespace:
  commonLabels:
    accurate.cybozu.com/template: init-template
  commonAnnotations:
    foo: bar
  roleBindingTemplate: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: admin
    subjects:
      - apiGroup: rbac.authorization.k8s.io
        kind: Group
        name: {{ .Name }}
      {{- range .Roles.admin }}
      - apiGroup: rbac.authorization.k8s.io
        kind: Group
        name: {{ .Name }}
      {{- end }}
argocd:
  namespace: argocd
  appProjectTemplate: |
    apiVersion: argoproj.io/v1alpha1
    kind: AppProject
    spec:
      destinations:
      {{- range .Namespaces }}
        - namespace: {{ . }}
          server: '*'
      {{- end }}
      roles:
        - groups:
            # If `GitHubName` is specified as `ExtraParams`, use it, otherwise use `Name`.
            - {{with .ExtraParams.GitHubTeam}}{{ . }}{{else}}{{ .Name }}{{end}}
            {{- range .Roles.admin }}
            - {{with .ExtraParams.GitHubTeam}}{{ . }}{{else}}{{ .Name }}{{end}}
            {{- end }}
          name: admin
          policies:
            - p, proj:{{ .Name }}:admin, applications, *, {{ .Name }}/*, allow
      sourceNamespaces:
        {{- range .Namespaces }}
        - {{ . }}
        {{- end }}
      sourceRepos:
        {{- range .Repositories }}
        - '{{ . }}'
        {{- else }}
        - '*'
        {{- end }}
</code></pre>
<p><code>roleBindingTemplate</code> and <code>appProjectTemplate</code> can be written in go-template format.</p>
<p><code>roleBindingTemplate</code> can use the following variables:</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>Name</code></td><td><code>string</code></td><td>The name of the tenant.</td></tr>
<tr><td><code>Roles</code></td><td><code>map[string]Role</code></td><td>Map of other tenants that are accessible to this tenant. The key is a role name.</td></tr>
<tr><td><code>ExtraParams</code></td><td><code>map[string]string</code></td><td>Extra parameters specified per tenant.</td></tr>
</tbody></table>
</div>
<p><code>appProjectTemplate</code> can use the following variables:</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>Name</code></td><td><code>string</code></td><td>The name of the tenant.</td></tr>
<tr><td><code>Namespaces</code></td><td><code>[]string</code></td><td>List of namespaces belonging to a tenant (including sub-namespaces).</td></tr>
<tr><td><code>Repositories</code></td><td><code>[]string</code></td><td>List of repository URLs which can be used by the tenant.</td></tr>
<tr><td><code>Roles</code></td><td><code>map[string]Role</code></td><td>Map of other tenants that are accessible to this tenant. The key is a role name.</td></tr>
<tr><td><code>ExtraParams</code></td><td><code>map[string]string</code></td><td>Extra parameters specified per tenant.</td></tr>
</tbody></table>
</div><div class="table-wrapper"><table><thead><tr><th>Key</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>Name</code></td><td><code>string</code></td><td>The name of the tenant.</td></tr>
<tr><td><code>ExtraParams</code></td><td><code>map[string]string</code></td><td>Extra parameters specified per tenant.</td></tr>
</tbody></table>
</div>
<h2 id="environment-variables"><a class="header" href="#environment-variables">Environment variables</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Required</th><th>Description</th></tr></thead><tbody>
<tr><td><code>POD_NAMESPACE</code></td><td>Yes</td><td>The namespace name where <code>cattage</code> is running.</td></tr>
</tbody></table>
</div>
<h2 id="command-line-flags"><a class="header" href="#command-line-flags">Command-line flags</a></h2>
<pre><code class="language-txt">Flags:
      --add_dir_header                   If true, adds the file directory to the header
      --alsologtostderr                  log to standard error as well as files
      --cert-dir string                  webhook certificate directory
      --config-file string               Configuration file path (default "/etc/cattage/config.yaml")
      --health-probe-addr string         Listen address for health probes (default ":8081")
  -h, --help                             help for cattage-controller
      --leader-election-id string        ID for leader election by controller-runtime (default "cattage")
      --log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace (default :0)
      --log_dir string                   If non-empty, write log files in this directory
      --log_file string                  If non-empty, use this log file
      --log_file_max_size uint           Defines the maximum size a log file can grow to. Unit is megabytes. If the value is 0, the maximum file size is unlimited. (default 1800)
      --logtostderr                      log to standard error instead of files (default true)
      --metrics-addr string              The address the metric endpoint binds to (default ":8080")
      --skip_headers                     If true, avoid header prefixes in the log messages
      --skip_log_headers                 If true, avoid headers when opening log files
      --stderrthreshold severity         logs at or above this threshold go to stderr (default 2)
  -v, --v Level                          number for the log level verbosity
      --version                          version for cattage-controller
      --vmodule moduleSpec               comma-separated list of pattern=N settings for file-filtered logging
      --webhook-addr string              Listen address for the webhook endpoint (default ":9443")
      --zap-devel                        Development Mode defaults(encoder=consoleEncoder,logLevel=Debug,stackTraceLevel=Warn). Production Mode defaults(encoder=jsonEncoder,logLevel=Info,stackTraceLevel=Error)
      --zap-encoder encoder              Zap log encoding (one of 'json' or 'console')
      --zap-log-level level              Zap Level to configure the verbosity of logging. Can be one of 'debug', 'info', 'error', or any integer value &gt; 0 which corresponds to custom debug levels of increasing verbosity
      --zap-stacktrace-level level       Zap Level at and above which stacktraces are captured (one of 'info', 'error', 'panic').
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design-notes"><a class="header" href="#design-notes">Design notes</a></h1>
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>Cattage is a Kubernetes controller that enhances the multi-tenancy of <a href="https://argo-cd.readthedocs.io/">Argo CD</a> with <a href="https://cybozu-go.github.io/accurate/">Accurate</a>.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>There is a known limitation for Argo CD to implement app-of-apps pattern in a multi-tenancy environment.</p>
<p><a href="https://github.com/argoproj/argo-cd/issues/2785">https://github.com/argoproj/argo-cd/issues/2785</a></p>
<p>We have developed the following mechanism to resolve the problem.</p>
<p><a href="https://blog.kintone.io/entry/production-grade-delivery-workflow-using-argocd#Multi-tenancy">https://blog.kintone.io/entry/production-grade-delivery-workflow-using-argocd#Multi-tenancy</a></p>
<p>However, the mechanism still has the following problems:</p>
<ul>
<li>When a SubNamespace is created in <a href="https://github.com/kubernetes-sigs/hierarchical-namespaces">HNC</a> or <a href="https://cybozu-go.github.io/accurate/">Accurate</a>, an administrator needs to add it to the destinations of the Application resource.
(Argo CD supports specifying wildcards in destinations, but that is not enough for us.)</li>
</ul>
<p>We need to build a better solution.</p>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<ul>
<li>Develop a Kubernetes custom controller to automate the configuration for multi-tenancy of Argo CD with Accurate.</li>
<li>Automates the creation of root-namespaces and AppProject for each tenant.</li>
<li>Allow tenant users to create Application resources in any namespace.</li>
<li>Perform strict validation of Application resources for security.</li>
</ul>
<h2 id="user-stories"><a class="header" href="#user-stories">User stories</a></h2>
<h3 id="adding-a-tenant"><a class="header" href="#adding-a-tenant">Adding a tenant</a></h3>
<p>An administrator only need to create one custom resource to add a tenant to a Kubernetes cluster.
No more manual operations to add Applications, AppProjects and Namespaces.</p>
<p>Tenant users can create sub-namespaces within their tenant.</p>
<h3 id="adding-an-app-of-apps-application"><a class="header" href="#adding-an-app-of-apps-application">Adding an app-of-apps Application</a></h3>
<p>Tenant users can create Application resources within their sub-namespaces.
Application resources are strictly validated.
No more deploying to another tenant's namespace by mistake.</p>
<h3 id="changing-ownership"><a class="header" href="#changing-ownership">Changing ownership</a></h3>
<p>There are cases where you want to move ownership of an application between tenants.
Accurate supports <code>kubectl accurate sub move</code> command to change the parent of a sub-namespace.</p>
<p><a href="https://cybozu-go.github.io/accurate/subnamespaces.html#changing-the-parent-of-a-sub-namespace">https://cybozu-go.github.io/accurate/subnamespaces.html#changing-the-parent-of-a-sub-namespace</a></p>
<p>An administrators can use this command to move the sub-namespace to another tenant.
The permission of AppProjects, Applications and Namespaces will be updated automatically.</p>
<h2 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h2>
<h3 id="applicationset"><a class="header" href="#applicationset">ApplicationSet</a></h3>
<p>ApplicationSet is one of the features of Argo CD which generates Application resources based on user input.</p>
<p><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/application-set/">https://argo-cd.readthedocs.io/en/stable/user-guide/application-set/</a></p>
<p>However, this feature does not give tenant users enough flexibility in their settings.</p>
<h3 id="appsource-controller"><a class="header" href="#appsource-controller">AppSource Controller</a></h3>
<p>AppSource controller is similar to our proposal.</p>
<p><a href="https://github.com/argoproj-labs/appsource">https://github.com/argoproj-labs/appsource</a></p>
<p>But AppSource is still not production-ready.
Also, it does not solve our some problems.</p>
<h3 id="multiple-argo-cd-instance-argocd-operator"><a class="header" href="#multiple-argo-cd-instance-argocd-operator">Multiple Argo CD instance (argocd-operator)</a></h3>
<p>We considered having an Argo CD instance for each tenant team, but it turned out to be a permissions problem.</p>
<h3 id="other-continuous-delivery-tools"><a class="header" href="#other-continuous-delivery-tools">Other Continuous Delivery tools</a></h3>
<p>Other Continuous Delivery tools support multi-tenancy.</p>
<ul>
<li><a href="https://github.com/fluxcd/flux2">https://github.com/fluxcd/flux2</a></li>
<li><a href="https://github.com/pipe-cd/pipe">https://github.com/pipe-cd/pipe</a></li>
</ul>
<p>However, we love Argo CD (the many features and the useful UI).
We already have a lot of manifests managed by Argo CD. It's hard to switch to another tool now.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development"><a class="header" href="#development">Development</a></h1>
<ol>
<li>
<p>Prepare a Linux box running Docker.</p>
</li>
<li>
<p>Checkout this repository.</p>
<pre><code class="language-sh">git clone https://github.com/cybozu-go/cattage
</code></pre>
</li>
</ol>
<h2 id="setup-cli-tools"><a class="header" href="#setup-cli-tools">Setup CLI tools</a></h2>
<ol>
<li>
<p>Install <a href="https://aquaproj.github.io">aqua</a>.</p>
<p><a href="https://aquaproj.github.io/docs/tutorial-basics/quick-start">https://aquaproj.github.io/docs/tutorial-basics/quick-start</a></p>
</li>
<li>
<p>Install CLI tools.</p>
<pre><code class="language-sh">cd cybozu-go/cattage
aqua i -l
</code></pre>
</li>
</ol>
<h2 id="development--debug"><a class="header" href="#development--debug">Development &amp; Debug</a></h2>
<ol>
<li>
<p>Launch local Kubernetes cluster.</p>
<pre><code class="language-sh">cd cybozu-go/cattage
make dev
</code></pre>
</li>
<li>
<p>Start <a href="https://tilt.dev">Tilt</a>.</p>
<pre><code class="language-sh">tilt up
</code></pre>
</li>
<li>
<p>Access: <code>http://localhost:10350/</code></p>
</li>
<li>
<p>Stop the Kubernetes cluster.</p>
<pre><code class="language-sh">make stop-dev
</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="release-procedure"><a class="header" href="#release-procedure">Release procedure</a></h1>
<p>This document describes how to release a new version.</p>
<h2 id="labeling"><a class="header" href="#labeling">Labeling</a></h2>
<p>Release notes are automatically generated based on PRs included in the release.
Those PRs are categorized based on the label assigned to them.
Please refer to <code>.github/release.yml</code> for the kind of labels.</p>
<h2 id="versioning"><a class="header" href="#versioning">Versioning</a></h2>
<p>Follow <a href="https://semver.org/spec/v2.0.0.html">semantic versioning 2.0.0</a> to choose the new version number.</p>
<h2 id="bump-version"><a class="header" href="#bump-version">Bump version</a></h2>
<ol>
<li>
<p>Determine a new version number. Then set <code>VERSION</code> variable.</p>
<pre><code class="language-sh"># Set VERSION and confirm it. It should not have "v" prefix.
VERSION=x.y.z
echo $VERSION
</code></pre>
</li>
<li>
<p>Add a git tag to the main HEAD, then push it.</p>
<pre><code class="language-sh">git switch main
git tag -a -m "Release v$VERSION" "v$VERSION"
git tag -ln | grep $VERSION
git push origin v$VERSION
</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="maintenance"><a class="header" href="#maintenance">Maintenance</a></h1>
<h2 id="how-to-update-supported-kubernetes"><a class="header" href="#how-to-update-supported-kubernetes">How to update supported Kubernetes</a></h2>
<p>Cattage supports the three latest Kubernetes versions.
If a new Kubernetes is released, please update the following files.</p>
<ul>
<li>Update Kubernetes version in <code>e2e/Makefile</code>, <code>.github/workflows/ci.yaml</code> and <code>cluster.yaml</code>.</li>
<li>Update kubectl version in <code>aqua.yaml</code>.</li>
<li>Update <code>k8s.io/*</code> and <code>sigs.k8s.io/controller-runtime</code> packages version in <code>go.mod</code>.</li>
</ul>
<p>If Kubernetes or controller-runtime API has changed, please fix the relevant source code.</p>
<h2 id="how-to-update-supported-argo-cd"><a class="header" href="#how-to-update-supported-argo-cd">How to update supported Argo CD</a></h2>
<p>Cattage supports one Argo CD version.
If a new Argo CD is released, please update the following files.</p>
<ul>
<li>Update Argo CD Version in <code>aqua.yaml</code> and <code>Makefile</code>.</li>
<li>Run <code>make crds</code>.</li>
</ul>
<p>If Argo CD API has changed, please fix the relevant source code.</p>
<h2 id="how-to-update-dependencies"><a class="header" href="#how-to-update-dependencies">How to update dependencies</a></h2>
<p>Renovate will create PRs that update dependencies once a week.
However, Argo CD is not subject to Renovate. Also, Kubernetes is only updated with patched versions.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
